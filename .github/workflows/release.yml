name: Build and Publish

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to build and publish (e.g., v1.0.1)"
        required: true
        type: string

env:
  # Setting an environment variable with the value of a configuration variable
  env_var: ${{ vars.ENV_CONTEXT_VAR }}

permissions:
  contents: write

jobs:
  quality-checks:
    name: Pre-Release Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Determine tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "TAG=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.tag.outputs.TAG }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript type checking
        run: npm run compile

      - name: Run Biome lint and format check
        run: npm run check

  build-all-browsers:
    name: Build - ${{ matrix.browser }}
    runs-on: ubuntu-latest
    needs: quality-checks
    environment: chrome

    strategy:
      fail-fast: true
      matrix:
        browser:
          - chrome
          - firefox
          - edge

    steps:
      - name: Determine tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "TAG=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.tag.outputs.TAG }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build extension for ${{ matrix.browser }}
        run: |
          if [ "${{ matrix.browser }}" = "chrome" ]; then
            npm run build
          elif [ "${{ matrix.browser }}" = "firefox" ]; then
            npm run build:firefox
          elif [ "${{ matrix.browser }}" = "edge" ]; then
            npm run build:edge
          fi

      - name: Create ZIP for ${{ matrix.browser }}
        run: |
          if [ "${{ matrix.browser }}" = "chrome" ]; then
            npm run zip
          elif [ "${{ matrix.browser }}" = "firefox" ]; then
            npm run zip:firefox
          elif [ "${{ matrix.browser }}" = "edge" ]; then
            npm run zip:edge
          fi

      - name: Get version from tag
        id: version
        run: |
          TAG="${{ steps.tag.outputs.TAG }}"
          echo "VERSION=${TAG#v}" >> $GITHUB_OUTPUT

      - name: Find and rename ZIP file
        id: zip
        run: |
          if [ "${{ matrix.browser }}" = "chrome" ]; then
            ZIP_FILE=$(find dist -name "*-chrome.zip" -type f | head -n 1)
            NEW_NAME="recosite-${{ steps.version.outputs.VERSION }}-chrome.zip"
          elif [ "${{ matrix.browser }}" = "firefox" ]; then
            ZIP_FILE=$(find dist -name "*-firefox.zip" -type f | head -n 1)
            NEW_NAME="recosite-${{ steps.version.outputs.VERSION }}-firefox.zip"
          elif [ "${{ matrix.browser }}" = "edge" ]; then
            ZIP_FILE=$(find dist -name "*-edge.zip" -type f | head -n 1)
            NEW_NAME="recosite-${{ steps.version.outputs.VERSION }}-edge.zip"
          fi

          if [ -z "$ZIP_FILE" ]; then
            echo "Error: ZIP file not found for ${{ matrix.browser }}"
            exit 1
          fi

          NEW_PATH="dist/$NEW_NAME"

          # Only move if the file names are different
          if [ "$ZIP_FILE" != "$NEW_PATH" ]; then
            mv "$ZIP_FILE" "$NEW_PATH"
          fi

          echo "ZIP_PATH=$NEW_PATH" >> $GITHUB_OUTPUT
          echo "ZIP_NAME=$NEW_NAME" >> $GITHUB_OUTPUT

      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-${{ matrix.browser }}
          path: ${{ steps.zip.outputs.ZIP_PATH }}
          retention-days: 90

  upload-release-assets:
    name: Upload Release Assets
    runs-on: ubuntu-latest
    needs: build-all-browsers
    environment: chrome

    steps:
      - name: Determine tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "TAG=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.tag.outputs.TAG }}

      - name: Get version from tag
        id: version
        run: |
          TAG="${{ steps.tag.outputs.TAG }}"
          echo "VERSION=${TAG#v}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: List artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -R release-artifacts/

      - name: Upload assets to existing GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.TAG }}
          files: |
            release-artifacts/extension-chrome/recosite-${{ steps.version.outputs.VERSION }}-chrome.zip
            release-artifacts/extension-firefox/recosite-${{ steps.version.outputs.VERSION }}-firefox.zip
            release-artifacts/extension-edge/recosite-${{ steps.version.outputs.VERSION }}-edge.zip
          fail_on_unmatched_files: true
          append_body: true
          body: |

            ## ğŸ“¦ Installation

            ### Chrome
            - **Recommended**: Install from [Chrome Web Store](https://chromewebstore.google.com/detail/recosite/cajchbamocblcjllnllipgpioahkhlhk) (auto-updated)
            - **Manual**: Download [`recosite-${{ steps.version.outputs.VERSION }}-chrome.zip`](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.TAG }}/recosite-${{ steps.version.outputs.VERSION }}-chrome.zip)

            ### Firefox
            - Download [`recosite-${{ steps.version.outputs.VERSION }}-firefox.zip`](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.TAG }}/recosite-${{ steps.version.outputs.VERSION }}-firefox.zip)
            - Extract and load as temporary add-on

            ### Edge
            - Download [`recosite-${{ steps.version.outputs.VERSION }}-edge.zip`](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.TAG }}/recosite-${{ steps.version.outputs.VERSION }}-edge.zip)
            - Extract and load in developer mode

  publish-chrome-web-store:
    name: Publish to Chrome Web Store
    runs-on: ubuntu-latest
    needs: [build-all-browsers, upload-release-assets]
    environment: chrome

    steps:
      - name: Determine tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "TAG=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Get version from tag
        id: version
        run: |
          TAG="${{ steps.tag.outputs.TAG }}"
          echo "VERSION=${TAG#v}" >> $GITHUB_OUTPUT

      - name: Download Chrome artifact
        uses: actions/download-artifact@v4
        with:
          name: extension-chrome
          path: chrome-release

      - name: List Chrome artifact
        run: |
          echo "Chrome artifact contents:"
          ls -la chrome-release/

      - name: Verify Chrome Web Store secrets
        run: |
          echo "Checking Chrome Web Store secrets..."
          if [ -z "${{ vars.CHROME_EXTENSION_ID }}" ]; then
            echo "âŒ CHROME_EXTENSION_ID is not set"
            exit 1
          else
            echo "âœ… CHROME_EXTENSION_ID is set"
          fi

          if [ -z "${{ vars.CHROME_CLIENT_ID }}" ]; then
            echo "âŒ CHROME_CLIENT_ID is not set"
            exit 1
          else
            echo "âœ… CHROME_CLIENT_ID is set"
          fi

          if [ -z "${{ secrets.CHROME_CLIENT_SECRET }}" ]; then
            echo "âŒ CHROME_CLIENT_SECRET is not set"
            exit 1
          else
            echo "âœ… CHROME_CLIENT_SECRET is set"
          fi

          if [ -z "${{ secrets.CHROME_REFRESH_TOKEN }}" ]; then
            echo "âŒ CHROME_REFRESH_TOKEN is not set"
            exit 1
          else
            echo "âœ… CHROME_REFRESH_TOKEN is set"
          fi

      - name: Upload to Chrome Web Store
        id: chrome_upload
        uses: mnao305/chrome-extension-upload@v5.0.0
        continue-on-error: true
        with:
          file-path: chrome-release/recosite-${{ steps.version.outputs.VERSION }}-chrome.zip
          extension-id: ${{ vars.CHROME_EXTENSION_ID }}
          client-id: ${{ vars.CHROME_CLIENT_ID }}
          client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          publish: true

      - name: Check upload result
        run: |
          if [ "${{ steps.chrome_upload.outcome }}" = "success" ]; then
            echo "âœ… Extension successfully uploaded and published to Chrome Web Store!"
            echo "Extension ID: ${{ vars.CHROME_EXTENSION_ID }}"
            echo "Version: ${{ steps.version.outputs.VERSION }}"
          else
            echo "âš ï¸ Extension uploaded to Chrome Web Store but auto-publish failed"
            echo "Extension ID: ${{ vars.CHROME_EXTENSION_ID }}"
            echo "Version: ${{ steps.version.outputs.VERSION }}"
            echo ""
            echo "ğŸ“ Next steps:"
            echo "1. Go to Chrome Web Store Developer Dashboard:"
            echo "   https://chrome.google.com/webstore/devconsole"
            echo "2. Select your extension: recosite"
            echo "3. Click 'Submit for review' to publish the new version"
            echo ""
            echo "The extension package has been successfully uploaded and is ready for manual publishing."
          fi

  build-success:
    name: Build and Publish Success
    runs-on: ubuntu-latest
    needs:
      [
        quality-checks,
        build-all-browsers,
        upload-release-assets,
        publish-chrome-web-store,
      ]
    if: always()

    steps:
      - name: Determine tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "TAG=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Check all jobs status
        run: |
          if [ "${{ needs.quality-checks.result }}" != "success" ] || \
             [ "${{ needs.build-all-browsers.result }}" != "success" ] || \
             [ "${{ needs.upload-release-assets.result }}" != "success" ] || \
             [ "${{ needs.publish-chrome-web-store.result }}" != "success" ]; then
            echo "âŒ Build and publish failed: One or more jobs failed"
            exit 1
          fi
          echo "âœ… All build and publish jobs completed successfully!"
          echo ""
          echo "ğŸ“¦ Assets uploaded to GitHub Release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.tag.outputs.TAG }}"
          echo "ğŸš€ Chrome extension published to Chrome Web Store"
          echo "ğŸ“¥ Firefox and Edge extensions available for download from GitHub Release"
