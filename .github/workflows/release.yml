name: Build and Publish

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  quality-checks:
    name: Pre-Release Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript type checking
        run: npm run compile

      - name: Run Biome lint and format check
        run: npm run check

  build-all-browsers:
    name: Build - ${{ matrix.browser }}
    runs-on: ubuntu-latest
    needs: quality-checks

    strategy:
      fail-fast: true
      matrix:
        browser:
          - chrome
          - firefox
          - edge

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build extension for ${{ matrix.browser }}
        run: |
          if [ "${{ matrix.browser }}" = "chrome" ]; then
            npm run build
          elif [ "${{ matrix.browser }}" = "firefox" ]; then
            npm run build:firefox
          elif [ "${{ matrix.browser }}" = "edge" ]; then
            npm run build:edge
          fi

      - name: Create ZIP for ${{ matrix.browser }}
        run: |
          if [ "${{ matrix.browser }}" = "chrome" ]; then
            npm run zip
          elif [ "${{ matrix.browser }}" = "firefox" ]; then
            npm run zip:firefox
          elif [ "${{ matrix.browser }}" = "edge" ]; then
            npm run zip:edge
          fi

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Find and rename ZIP file
        id: zip
        run: |
          if [ "${{ matrix.browser }}" = "chrome" ]; then
            ZIP_FILE=$(find dist -name "*-chrome.zip" -type f | head -n 1)
            NEW_NAME="recosite-${{ steps.version.outputs.VERSION }}-chrome.zip"
          elif [ "${{ matrix.browser }}" = "firefox" ]; then
            ZIP_FILE=$(find dist -name "*-firefox.zip" -type f | head -n 1)
            NEW_NAME="recosite-${{ steps.version.outputs.VERSION }}-firefox.zip"
          elif [ "${{ matrix.browser }}" = "edge" ]; then
            ZIP_FILE=$(find dist -name "*-edge.zip" -type f | head -n 1)
            NEW_NAME="recosite-${{ steps.version.outputs.VERSION }}-edge.zip"
          fi

          if [ -z "$ZIP_FILE" ]; then
            echo "Error: ZIP file not found for ${{ matrix.browser }}"
            exit 1
          fi

          mv "$ZIP_FILE" "dist/$NEW_NAME"
          echo "ZIP_PATH=dist/$NEW_NAME" >> $GITHUB_OUTPUT
          echo "ZIP_NAME=$NEW_NAME" >> $GITHUB_OUTPUT

      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-${{ matrix.browser }}
          path: ${{ steps.zip.outputs.ZIP_PATH }}
          retention-days: 90

  upload-release-assets:
    name: Upload Release Assets
    runs-on: ubuntu-latest
    needs: build-all-browsers

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: List artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -R release-artifacts/

      - name: Upload assets to existing GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-artifacts/extension-chrome/recosite-${{ steps.version.outputs.VERSION }}-chrome.zip
            release-artifacts/extension-firefox/recosite-${{ steps.version.outputs.VERSION }}-firefox.zip
            release-artifacts/extension-edge/recosite-${{ steps.version.outputs.VERSION }}-edge.zip
          fail_on_unmatched_files: true

  publish-chrome-web-store:
    name: Publish to Chrome Web Store
    runs-on: ubuntu-latest
    needs: [build-all-browsers, upload-release-assets]

    steps:
      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download Chrome artifact
        uses: actions/download-artifact@v4
        with:
          name: extension-chrome
          path: chrome-release

      - name: List Chrome artifact
        run: |
          echo "Chrome artifact contents:"
          ls -la chrome-release/

      - name: Upload to Chrome Web Store
        uses: mnao305/chrome-extension-upload@v5.0.0
        with:
          file-path: chrome-release/recosite-${{ steps.version.outputs.VERSION }}-chrome.zip
          extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
          client-id: ${{ secrets.CHROME_CLIENT_ID }}
          client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          publish: true

      - name: Publish success
        run: |
          echo "‚úÖ Extension successfully published to Chrome Web Store!"
          echo "Extension ID: ${{ secrets.CHROME_EXTENSION_ID }}"
          echo "Version: ${{ steps.version.outputs.VERSION }}"

  build-success:
    name: Build and Publish Success
    runs-on: ubuntu-latest
    needs:
      [
        quality-checks,
        build-all-browsers,
        upload-release-assets,
        publish-chrome-web-store,
      ]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          if [ "${{ needs.quality-checks.result }}" != "success" ] || \
             [ "${{ needs.build-all-browsers.result }}" != "success" ] || \
             [ "${{ needs.upload-release-assets.result }}" != "success" ] || \
             [ "${{ needs.publish-chrome-web-store.result }}" != "success" ]; then
            echo "‚ùå Build and publish failed: One or more jobs failed"
            exit 1
          fi
          echo "‚úÖ All build and publish jobs completed successfully!"
          echo ""
          echo "üì¶ Assets uploaded to GitHub Release: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
          echo "üöÄ Chrome extension published to Chrome Web Store"
          echo "üì• Firefox and Edge extensions available for download from GitHub Release"
